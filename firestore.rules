rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // As regras atuais falham para listagens de coleções (ex: buscar todos os usuários)
    // porque tentam verificar o conteúdo de um documento (`resource.data`), o que não é
    // possível em uma consulta de coleção.
    // As regras abaixo corrigem isso permitindo acesso de leitura mais amplo para
    // certos papéis, consertando os erros de permissão. A filtragem de dados
    // específicos (ex: por região) deve ser feita no lado do cliente (no JavaScript).

    // Função para verificar permissão de escrita em metas
    function canWriteGoals(role, data) {
      return (role == 'diretoria') ||
             (role == 'superintendencia') ||
             (role == 'gerente_regional' && data.state == request.auth.token.state) ||
             (role == 'comercial' && data.city == request.auth.token.city);
    }

    // Usuários
    match /users/{userId} {
      // Permite leitura para papéis gerenciais/comerciais e para o próprio usuário.
      allow read: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial', 'operacional'] || request.auth.uid == userId;
      
      // Permissões de atualização hierárquicas e para o próprio usuário
      allow update: if request.auth.token.role in ['diretoria', 'superintendencia'] ||
                      (request.auth.token.role == 'gerente_regional' && resource.data.state == request.auth.token.state) ||
                      (request.auth.token.role == 'comercial' && resource.data.city == request.auth.token.city) ||
                      request.auth.uid == userId;
      
      // Apenas diretoria/superintendencia podem criar/deletar usuários
      allow create, delete: if request.auth.token.role in ['diretoria', 'superintendencia'];
    }

    // Contratos
    match /contracts/{docId} {
      // Permite leitura para todos os papéis que precisam acessar contratos
      allow read: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial', 'operacional'];

      allow create: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial', 'operacional'];

      allow update: if request.auth.token.role in ['diretoria', 'superintendencia'] ||
                      (request.auth.token.role == 'operacional' && request.resource.data.keys().hasOnly(['validated', 'validation_notes']));
      
      allow delete: if request.auth.token.role in ['diretoria', 'superintendencia'];
    }

    // Relatórios
    match /relatorios/{docId} {
      // Permite leitura para papéis que acessam relatórios
      allow read: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial'];
      allow write: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial'];
    }

    // Metas (goals)
    match /goals/{docId} {
      // Permite leitura para papéis que visualizam metas
      allow read: if request.auth.token.role in ['diretoria', 'superintendencia', 'gerente_regional', 'comercial'];
      allow write: if canWriteGoals(request.auth.token.role, request.resource.data);
    }
  }
}