rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership based on user role and data hierarchy.
    function isOwner(role, data) {
      return (role == 'superintendencia' && data.region == request.auth.token.region) ||
             (role == 'gerencia_regional' && data.state == request.auth.token.state) ||
             (role == 'comercial' && data.city == request.auth.token.city) ||
             (role == 'operacional' && data.userId == request.auth.uid);
    }

    // The 'diretoria' role has full read and write access to all collections.
    // For other roles, specific permissions are checked below.

    match /dashboard/{docId} {
      allow read: if request.auth.token.role == 'diretoria' || isOwner(request.auth.token.role, resource.data);
      allow write: if request.auth.token.role == 'diretoria';
    }

    match /users/{userId} {
      allow get: if request.auth.token.role == 'diretoria' || request.auth.uid == userId || isOwner(request.auth.token.role, resource.data);
      allow list: if request.auth.token.role == 'diretoria' || isOwner(request.auth.token.role, resource.data);
      allow update: if request.auth.token.role == 'diretoria' || request.auth.uid == userId;
      allow create, delete: if request.auth.token.role == 'diretoria';
    }

    // CORRECTED: Changed from /contratos to /contracts
    match /contracts/{docId} {
      allow read: if request.auth.token.role == 'diretoria' || isOwner(request.auth.token.role, resource.data);
      allow create: if request.auth.token.role == 'diretoria' || request.auth.token.role == 'comercial' || request.auth.token.role == 'operacional';
      allow update: if request.auth.token.role == 'diretoria' || (request.auth.token.role == 'operacional' && request.resource.data.keys().hasOnly(['validated', 'validation_notes']));
      allow delete: if request.auth.token.role == 'diretoria';
    }

    match /relatorios/{docId} {
      allow read: if request.auth.token.role == 'diretoria' || isOwner(request.auth.token.role, resource.data);
      allow write: if request.auth.token.role == 'diretoria';
    }

    // CORRECTED: Changed from /metas to /goals
    match /goals/{docId} {
      allow read: if request.auth.token.role == 'diretoria' || isOwner(request.auth.token.role, resource.data);
      allow write: if request.auth.token.role == 'diretoria';
    }
  }
}
